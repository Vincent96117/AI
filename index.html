<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>üî± TRIDENT V17.1 - FINAL</title>
    <style>
        :root { --bg: #050505; --card: #0d0d0d; --accent: #00ffcc; --text: #f0f0f0; --purple: #d400ff; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .header { background: #111; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; margin-bottom: 20px; }
        #deck { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { background: var(--card); border: 1px solid #222; border-radius: 15px; padding: 20px; border-top: 4px solid #333; }
        .symbol { font-size: 1.8rem; font-weight: 900; color: var(--accent); }
        .fd-tag { background: #222; padding: 4px 10px; border-radius: 6px; font-family: monospace; font-size: 0.9rem; }
        .alert-purple { background: var(--purple) !important; color: white !important; box-shadow: 0 0 15px var(--purple); }
        .ai-box { background: #000; color: #fff; padding: 12px; border-radius: 10px; font-size: 0.9rem; border-left: 4px solid var(--accent); margin-top: 15px; min-height: 80px; white-space: pre-wrap; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="header"><h1>üî± TRIDENT <span style="color:var(--accent)">V17.1 GEMINI</span></h1></div>
    <div id="deck"></div>

    <script>
        const GEMINI_KEY = "AIzaSyCK5cMo5FL895WwRzggkFjPi0JRe5tVqXQ";
        const PUSHOVER = { u: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", t: "acyoe3sz15x4n91r1349fdcau7x6pw" };
        const BLACKLIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];

        let market = {};
        let isBusy = false;
        let lastReport = {};

        async function init() {
            const r = await fetch("https://fapi.binance.com/fapi/v1/premiumIndex");
            const d = await r.json();
            d.forEach(i => {
                if (i.symbol.endsWith("USDT") && !BLACKLIST.includes(i.symbol)) {
                    market[i.symbol] = { s: i.symbol, fd: parseFloat(i.lastFundingRate)*100, p: i.markPrice, startP: i.markPrice, hist: [] };
                }
            });
            const ws = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");
            ws.onmessage = (e) => {
                JSON.parse(e.data).forEach(t => {
                    if (market[t.s]) {
                        market[t.s].p = t.c;
                        market[t.s].hist.push(t.c);
                        if(market[t.s].hist.length > 20) market[t.s].hist.shift();
                    }
                });
                draw();
            };
        }

        function draw() {
            const list = Object.values(market).filter(x => x.p).sort((a,b) => Math.abs(b.fd) - Math.abs(a.fd)).slice(0,3);
            const deck = document.getElementById("deck");
            deck.innerHTML = "";
            list.forEach(item => {
                const isH = Math.abs(item.fd) >= 0.05;
                const div = document.createElement("div");
                div.className = "card";
                if(isH) div.style.borderColor = 'var(--purple)';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="symbol">${item.s}</span>
                        <span class="fd-tag ${isH?'alert-purple':''}">FD: ${item.fd.toFixed(4)}%</span>
                    </div>
                    <div style="margin-top:10px; font-size:0.85rem; color:#888;">ÁèæÂÉπ: ${item.p} | ÂßãÂÉπ: ${item.startP}</div>
                    <div id="ai-${item.s}" class="ai-box">>> Áõ£Ê∏¨Êï∏Êìö‰∏≠...</div>
                `;
                deck.appendChild(div);

                // Ëß∏ÁôºË®∫Êñ∑ÈÇèËºØ
                if (isH && !isBusy && (!lastReport[item.s] || Date.now() - lastReport[item.s] > 60000)) {
                    runGemini(item);
                }
            });
        }

        async function runGemini(item) {
            isBusy = true;
            lastReport[item.s] = Date.now();
            const box = document.getElementById(`ai-${item.s}`);
            box.innerText = ">> [Gemini] Ê≠£Âú®Ë®àÁÆóÊñúÁéáËàá‰∏ªÂäõÊÑèÂúñ...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `‰Ω†ÊòØÂä†ÂØÜË≤®Âπ£ÁãôÊìäÊâã„ÄÇÊ®ôÁöÑ:${item.s},Ë≥áË≤ª:${item.fd}%,Ëµ∞Âã¢Â∫èÂàó:${item.hist.slice(-10).join('->')}„ÄÇË´ãÁµ¶Âá∫Ôºö1.ÊòéÁ¢∫ÊñπÂêë(Â§ö/Á©∫) 2.È†êË®àÂ§ö‰πÖË°®ÊÖã(min) 3.‰∏ªÂäõÊÑèÂúñ 4.ÂãùÁéá„ÄÇÁπÅÈ´î‰∏≠ÊñáÔºåÁµêË´ñÊîæÁ¨¨‰∏ÄË°å„ÄÇ` }] }]
                    })
                });
                const data = await response.json();
                const res = data.candidates[0].content.parts[0].text;
                box.innerText = ">> " + res;

                // Pushover Ê®ôÈ°åÂÑ™Âåñ [cite: 2026-01-21]
                if (res.includes("9") || res.includes("È´ò")) {
                    const dir = res.includes("Â§ö") ? "Â§ö" : (res.includes("Á©∫") ? "Á©∫" : "ÔºÅ");
                    const timeMatch = res.match(/(\d+)\s*(min|ÂàÜ)/);
                    const time = timeMatch ? timeMatch[1] + "m" : "Âç≥Â∞á";
                    sendPushover(res, `„Äê${dir}/${time}„Äë${item.s}`);
                }
            } catch (err) { box.innerText = "‚ùå Gemini ÈÄ£Á∑öÂ§±Êïó: " + err.message; }
            finally { setTimeout(() => { isBusy = false; }, 8000); }
        }

        function sendPushover(msg, title) {
            fetch("https://api.pushover.net/1/messages.json", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `token=${PUSHOVER.t}&user=${PUSHOVER.u}&message=${encodeURIComponent(msg)}&title=${encodeURIComponent(title)}`
            });
        }
        init();
    </script>
</body>
</html>
