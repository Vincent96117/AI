<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>TRIDENT V6.7 - ABSOLUTE</title>
    <style>
        :root { --bg: #050505; --card: #0d0d0d; --accent: #00ffcc; --text: #f0f0f0; --purple: #d400ff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 10px; margin: 0; }
        .header { background: #111; padding: 12px; border-radius: 10px; text-align: center; border: 1px solid #333; margin-bottom: 10px; }
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; font-size: 0.7rem; background: #0a0a0a; padding: 8px; border-radius: 8px; border: 1px solid #222; }
        #sniper-deck { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 12px; }
        .card { background: var(--card); border: 1px solid #222; border-radius: 12px; padding: 15px; position: relative; }
        .symbol { font-size: 1.8rem; font-weight: 900; color: var(--accent); }
        .funding { font-family: monospace; font-size: 0.8rem; padding: 3px 7px; border-radius: 4px; border: 1px solid #333; }
        .alert-purple { background: var(--purple) !important; color: white !important; box-shadow: 0 0 15px var(--purple); border: none !important; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .item { background: #111; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #222; }
        .val { font-size: 0.95rem; font-weight: bold; font-family: monospace; color: #fff; }
        .ai-box { background: #000; color: var(--accent); padding: 10px; border-radius: 8px; font-size: 0.8rem; border-left: 3px solid var(--accent); min-height: 80px; border: 1px solid #222; line-height: 1.4; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="header"><h1>ğŸ”± TRIDENT <span style="color:var(--accent)">ABSOLUTE STABILITY</span></h1></div>
    <div class="dashboard">
        <div><span class="status-dot" style="background:#00ffcc"></span>L3 WSS ç›£æ§ä¸­</div>
        <div>ğŸŸ£ è³‡è²»è­¦æˆ’: Â±0.05% [cite: 2026-01-11]</div>
        <div>ğŸš« å·²æ’é™¤ BTC/ETH ç­‰ [cite: 2026-01-12]</div>
        <div>ğŸ“² Pushover å·²å°±ç·’ [cite: 2026-01-21]</div>
    </div>
    <div id="sniper-deck"></div>

    <script>
        const PUSHOVER_USER = "Gkhqyhobnxzjfwgvaiyp347m1jkhn4";
        const PUSHOVER_TOKEN = "acyoe3sz15x4n91r1349fdcau7x6pw";
        const GROQ_KEY = "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";
        const BLACKLIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];
        
        let market = {};
        let isAiBusy = false; // AI è«‹æ±‚é–
        let lastAiTime = {}; // å€‹åˆ¥å¹£ç¨®å†·å»

        // å•Ÿå‹•å¯¦æ™‚ L3 è¡Œæƒ…èˆ‡è³‡è²»æµ
        function initStreams() {
            const wsPrice = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");
            wsPrice.onmessage = (e) => {
                const data = JSON.parse(e.data);
                data.forEach(t => {
                    if (!t.s.endsWith("USDT") || BLACKLIST.includes(t.s)) return;
                    if (!market[t.s]) market[t.s] = { s: t.s, hist: [], fd: 0, oi: 0, v24h: 0 };
                    market[t.s].price = t.c;
                    market[t.s].change = t.P;
                    market[t.s].v24h = t.q;
                    market[t.s].hist.push(parseFloat(t.c));
                    if(market[t.s].hist.length > 25) market[t.s].hist.shift();
                });
                renderUI();
            };

            const wsFunding = new WebSocket("wss://fstream.binance.com/ws/!markPrice@arr@1s");
            wsFunding.onmessage = (e) => {
                const data = JSON.parse(e.data);
                data.forEach(i => { if(market[i.s]) market[i.s].fd = parseFloat(i.r) * 100; });
            };
        }

        function renderUI() {
            const sorted = Object.values(market)
                .filter(i => i.price)
                .sort((a, b) => (Math.abs(b.fd)*100 + Math.abs(b.change)) - (Math.abs(a.fd)*100 + Math.abs(a.change)))
                .slice(0, 3);

            const deck = document.getElementById('sniper-deck');
            deck.innerHTML = "";

            sorted.forEach(item => {
                const slope = item.hist.length > 10 ? ((item.hist[item.hist.length-1] - item.hist[0]) / item.hist[0] * 100) : 0;
                const isAlert = Math.abs(item.fd) >= 0.05;

                const card = document.createElement('div');
                card.className = 'card';
                if(isAlert) card.style.borderColor = 'var(--purple)';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="symbol">${item.s}</span>
                        <span class="funding ${isAlert ? 'alert-purple' : ''}">FD: ${item.fd.toFixed(4)}%</span>
                    </div>
                    <div class="data-grid">
                        <div class="item"><div style="font-size:0.6rem;color:#666">24H æˆäº¤</div><div class="val">${(item.v24h/1000000).toFixed(1)}M</div></div>
                        <div class="item"><div style="font-size:0.6rem;color:#666">1M æ–œç‡</div><div class="val" style="color:var(--accent)">${slope.toFixed(3)}%</div></div>
                        <div class="item"><div style="font-size:0.6rem;color:#666">24H æ¼²è·Œ</div><div class="val">${item.change}%</div></div>
                        <div class="item"><div style="font-size:0.6rem;color:#666">éšŠåˆ—ç‹€æ…‹</div><div class="val">${isAiBusy?'WAITING':'IDLE'}</div></div>
                    </div>
                    <div class="ai-box" id="ai-${item.s}">>> æ•¸æ“šæ”¶é›†ä¸­...ç¬¦åˆæ¢ä»¶å°‡è‡ªå‹•å•Ÿå‹•éšŠåˆ—</div>
                `;
                deck.appendChild(card);

                // è§¸ç™¼è¨ºæ–·é‚è¼¯
                if ((isAlert || Math.abs(slope) > 0.08) && canRunAI(item.s)) {
                    triggerAbsoluteAI(item, slope);
                }
            });
        }

        function canRunAI(s) {
            const now = Date.now();
            return !isAiBusy && (!lastAiTime[s] || now - lastAiTime[s] > 60000);
        }

        async function triggerAbsoluteAI(item, slope) {
            isAiBusy = true; // é–å®šå…¨å±€è«‹æ±‚
            lastAiTime[item.s] = Date.now();
            const box = document.getElementById(`ai-${item.s}`);
            box.innerText = ">> [éšŠåˆ—æˆåŠŸ] æ­£åœ¨å¼·åˆ· OI ä¸¦ç²å–è¨ºæ–·...";

            try {
                // 1. è¨ºæ–·å‰ç²å–å¯¦æ™‚ OI
                const oiRes = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${item.s}`).then(r => r.json());
                const oiVal = (parseFloat(oiRes.openInterest) / 1000000).toFixed(1);

                // 2. æ§‹å»ºæ¥µç°¡ Payload
                const prompt = `åˆ†æ ${item.s}: åƒ¹${item.price},æ–œç‡${slope.toFixed(3)}%,OI ${oiVal}M,è³‡è²»${item.fd.toFixed(4)}%. åˆ¤æ–·ä¸»åŠ›æ„åœ–èˆ‡å‹ç‡. ç¹é«”ä¸­æ–‡.`;

                const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama3-70b-8192",
                        messages: [{role: "user", content: prompt}],
                        temperature: 0.1
                    })
                });

                if (resp.status === 200) {
                    const data = await resp.json();
                    const result = data.choices[0].message.content;
                    box.innerText = ">> " + result;
                    
                    if(result.includes("90%") || result.includes("95%")) {
                        fetch("https://api.pushover.net/1/messages.json", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `token=${PUSHOVER_TOKEN}&user=${PUSHOVER_USER}&message=ğŸ¯ å¯¦æ™‚ç‹™æ“Š: ${item.s}\n${result}&title=ğŸ”± TRIDENT` });
                    }
                } else {
                    box.innerText = ">> ä¼ºæœå™¨å¿™ç¢Œï¼Œç¨å¾Œé‡è©¦";
                }
            } catch (err) {
                box.innerText = ">> è¨ºæ–·ç™¼ç”Ÿç•°å¸¸";
            } finally {
                // å¼·åˆ¶å»¶é² 5 ç§’å¾Œæ‰é‡‹æ”¾é–ï¼Œçµ¦ API å–˜æ¯æ™‚é–“
                setTimeout(() => { isAiBusy = false; }, 5000);
            }
        }

        initStreams();
    </script>
</body>
</html>
