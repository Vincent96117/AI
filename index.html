<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>TRIDENT V6.5 - FINAL REPAIR</title>
    <style>
        :root { --bg: #050505; --card: #0d0d0d; --accent: #00ffcc; --text: #f0f0f0; --purple: #d400ff; --warn: #ff3e3e; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 15px; }
        .header { background: #1a1a1a; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; margin-bottom: 10px; }
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; font-size: 0.75rem; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #222; }
        #sniper-deck { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
        .card { background: var(--card); border: 2px solid #222; border-radius: 18px; padding: 18px; position: relative; }
        .symbol { font-size: 2rem; font-weight: 900; color: var(--accent); }
        .funding { font-family: monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 5px; border: 1px solid #444; }
        .alert-purple { background: var(--purple) !important; color: white !important; box-shadow: 0 0 15px var(--purple); }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
        .item { background: #151515; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #222; }
        .val { font-size: 1rem; font-weight: bold; font-family: monospace; color: #fff; }
        .ai-box { background: #000; color: var(--accent); padding: 12px; border-radius: 10px; font-size: 0.82rem; border-left: 4px solid var(--accent); min-height: 80px; white-space: pre-wrap; margin-top: 10px; }
        .signal-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #333; }
        .active-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; letter-spacing:4px;">ğŸ”± TRIDENT <span style="color:var(--accent)">V6.5 FINAL</span></h1>
    </div>

    <div class="dashboard">
        <div><span id="dot-wss" class="signal-dot"></span> WSS æµé‡ï¼š<span id="stat-wss" style="color:var(--accent)">0</span></div>
        <div>ğŸ“¡ API ç‹€æ…‹ï¼š<span id="stat-api" style="color:var(--accent)">ç©©å®šç›£æ§</span></div>
        <div>ğŸš« é»‘åå–®ï¼š<span style="color:var(--warn)">BTC, ETH ç­‰å·²éš”é›¢ [cite: 2026-01-12]</span></div>
        <div>â³ ä¸‹æ¬¡æ›´æ–°ï¼š<span id="stat-timer" style="color:#fff">--</span></div>
    </div>

    <div id="sniper-deck"></div>

    <script>
        // [cite: 2026-01-21]
        const PUSHOVER_USER = "Gkhqyhobnxzjfwgvaiyp347m1jkhn4";
        const PUSHOVER_TOKEN = "acyoe3sz15x4n91r1349fdcau7x6pw";
        const GROQ_KEY = "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";
        const BLACKLIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];
        
        let market = {};
        let aiLock = false;
        let wssCount = 0;

        // 1. WebSocket å¼•æ“ (L3 åƒ¹æ ¼æµ)
        function initWSS() {
            const ws = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                const dot = document.getElementById('dot-wss');
                dot.classList.add('active-dot'); setTimeout(() => dot.classList.remove('active-dot'), 100);
                wssCount += data.length;

                data.forEach(t => {
                    if (!t.s.endsWith("USDT") || BLACKLIST.includes(t.s)) return;
                    if (!market[t.s]) market[t.s] = { symbol: t.s, history: [], volHistory: [] };
                    market[t.s].price = t.c;
                    market[t.s].change = t.P;
                    market[t.s].v = t.q; // æˆäº¤é¡
                    market[t.s].history.push(parseFloat(t.c));
                    market[t.s].volHistory.push(parseFloat(t.q));
                    if(market[t.s].history.length > 30) market[t.s].history.shift();
                });
                renderUI();
            };
            document.getElementById('stat-wss').innerText = wssCount;
            ws.onclose = () => setTimeout(initWSS, 5000);
        }

        // 2. ä¿®å¾©å¾Œçš„æ•¸æ“šè£œå…… (OI èˆ‡è³‡è²»)
        let timer = 1;
        async function fetchMetrics() {
            try {
                // é€™è£¡æˆ‘å€‘åªæŠ“ä¸€çµ„å¤§çš„ Premium Indexï¼Œæ¸›å°‘ API å£“åŠ›
                const pIndex = await fetch("https://fapi.binance.com/fapi/v1/premiumIndex").then(r => r.json());
                pIndex.forEach(i => {
                    if(market[i.symbol]) {
                        market[i.symbol].funding = parseFloat(i.lastFundingRate) * 100;
                    }
                });
                // åˆ†æ‰¹ç•°æ­¥æŠ“å–ç†±é–€å¹£çš„ OI
                const topSymbols = Object.values(market).sort((a,b) => b.v - a.v).slice(0, 15);
                for(let s of topSymbols) {
                    const oi = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${s.symbol}`).then(r => r.json());
                    market[s.symbol].oi = parseFloat(oi.openInterest);
                }
            } catch (e) { document.getElementById('stat-api').innerText = "API é »ç‡é™åˆ¶ä¸­"; }
            timer = 20;
        }

        setInterval(() => {
            timer--;
            document.getElementById('stat-timer').innerText = timer + "s";
            if(timer <= 0) fetchMetrics();
        }, 1000);

        // 3. UI æ¸²æŸ“èˆ‡å…¨è¦ç´ é¤µé£Ÿ
        function renderUI() {
            const sorted = Object.values(market)
                .filter(i => i.price && i.funding)
                .sort((a, b) => (Math.abs(b.funding)*100 + Math.abs(b.change)) - (Math.abs(a.funding)*100 + Math.abs(a.change)))
                .slice(0, 3);

            const deck = document.getElementById('sniper-deck');
            deck.innerHTML = "";

            sorted.forEach(item => {
                const isAlert = Math.abs(item.funding) >= 0.05; // [cite: 2026-01-11]
                const slope = item.history.length > 5 ? ((item.history[item.history.length-1] - item.history[0]) / item.history[0] * 100) : 0;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="symbol">${item.symbol}</span>
                        <span class="funding ${isAlert ? 'alert-purple' : ''}">FD: ${item.funding.toFixed(4)}%</span>
                    </div>
                    <div class="data-grid">
                        <div class="item"><div style="font-size:0.6rem;color:#666">OI (æŒå€‰)</div><div class="val">${item.oi ? (item.oi/1000000).toFixed(2) : '--'}M</div></div>
                        <div class="item"><div style="font-size:0.6rem;color:#666">1M æ–œç‡</div><div class="val" style="color:var(--accent)">${slope.toFixed(3)}%</div></div>
                        <div class="item"><div style="font-size:0.6rem;color:#666">æˆäº¤é¡</div><div class="val">${(item.v/1000000).toFixed(1)}M</div></div>
                        <div class="item"><div style="font-size:0.65rem;color:#888">è®Šç›¤ç‹€æ…‹</div><div class="val" style="color:${isAlert?'var(--purple)':'#555'}">${isAlert?'è§¸ç™¼è¨ºæ–·':'ç›£æ§ä¸­'}</div></div>
                    </div>
                    <div class="ai-box" id="ai-${item.symbol}">>> L3 æ•¸æ“šæ”¶é›†ä¸­... ç¬¦åˆæ–œç‡æˆ–è³‡è²»é–€æª»å°‡è‡ªå‹•è¨ºæ–·</div>
                `;
                deck.appendChild(card);

                if ((isAlert || Math.abs(slope) > 0.05) && !aiLock) askAI(item, slope);
            });
        }

        async function askAI(item, slope) {
            aiLock = true;
            try {
                const prompt = `ä½ æ˜¯åŠ å¯†ç‹™æ“Šæ‰‹ã€‚åˆ†æ ${item.symbol}ï¼šåƒ¹æ ¼ ${item.price}, 1Mæ–œç‡ ${slope.toFixed(4)}%, OI ${item.oi}M, è³‡è²» ${item.funding}%ã€‚ä»»å‹™ï¼š1.è­˜åˆ¥å‹æ…‹ 2.æ„åœ– 3.è¡¨æ…‹æ–¹å‘ 4.å™´ç™¼å€’æ•¸ 5.å‹ç‡ã€‚ç¹é«”ä¸­æ–‡ã€‚`;
                const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama3-70b-8192", messages: [{role: "user", content: prompt}], temperature: 0.1 })
                });
                const d = await resp.json();
                const res = d.choices[0].message.content;
                document.getElementById(`ai-${item.symbol}`).innerText = ">> " + res;
                if(res.includes("90%") || res.includes("95%")) {
                    fetch("https://api.pushover.net/1/messages.json", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `token=${PUSHOVER_TOKEN}&user=${PUSHOVER_USER}&message=ğŸ¯ è®Šç›¤è­¦å‘Š: ${item.symbol}\n${res}&title=ğŸ”± TRIDENT ALERT` });
                }
            } catch (e) {}
            setTimeout(() => { aiLock = false; }, 8000);
        }

        initWSS();
        fetchMetrics();
    </script>
</body>
</html>
