<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”± TRIDENT V21.0 - GEMINI LEVEL3</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .card { border: 2px solid #333; padding: 15px; margin-bottom: 15px; background: #050505; border-radius: 10px; border-top: 5px solid #00ffcc; }
        .symbol { font-size: 2rem; color: #00ffcc; font-weight: bold; }
        .stats { color: #888; font-size: 0.9rem; margin: 10px 0; }
        .ai-box { background: #111; padding: 15px; color: #fff; border-left: 5px solid #00ffcc; margin-top: 10px; font-size: 1.1rem; line-height: 1.6; min-height: 60px; white-space: pre-wrap; }
        .alert { border-color: #00ffcc !important; box-shadow: 0 0 15px #00ffcc; }
    </style>
</head>
<body>
    <h2>ğŸ”± TRIDENT V21.0 | <span style="color:#00ffcc">GEMINI LEVEL 3</span></h2>
    <div id="deck"></div>

    <script>
        // é€™æ˜¯ä½ çµ¦æˆ‘çš„ Gemini Key
        const GK = "AIzaSyCK5cMo5FL895WwRzggkFjPi0JRe5tVqXQ"; 
        const PU = "Gkhqyhobnxzjfwgvaiyp347m1jkhn4";
        const PT = "acyoe3sz15x4n91r1349fdcau7x6pw";
        const BLACKLIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];

        let market = {};
        let busy = false;

        async function init() {
            try {
                const r = await fetch("https://fapi.binance.com/fapi/v1/premiumIndex");
                const d = await r.json();
                d.forEach(i => {
                    if (i.symbol.endsWith("USDT") && !BLACKLIST.includes(i.symbol)) {
                        market[i.symbol] = { s: i.symbol, fd: parseFloat(i.lastFundingRate)*100, p: 0, histP: [] };
                    }
                });
                const ws = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");
                ws.onmessage = (e) => {
                    JSON.parse(e.data).forEach(t => {
                        if (market[t.s]) {
                            market[t.s].p = parseFloat(t.c);
                            market[t.s].histP.push(t.c);
                            if(market[t.s].histP.length > 5) market[t.s].histP.shift();
                        }
                    });
                    draw();
                };
            } catch (e) { console.error(e); }
        }

        async function getOI(s) {
            try {
                const r = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${s}`);
                const d = await r.json();
                return d.openInterest;
            } catch { return "æœªçŸ¥"; }
        }

        function draw() {
            const list = Object.values(market).filter(x => x.p > 0).sort((a,b) => Math.abs(b.fd) - Math.abs(a.fd)).slice(0,3);
            const deck = document.getElementById("deck");
            deck.innerHTML = "";
            list.forEach(item => {
                const isH = Math.abs(item.fd) >= 0.05;
                const div = document.createElement("div");
                div.className = `card ${isH?'alert':''}`;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span class="symbol">${item.s}</span>
                        <span style="color:${item.fd>=0?'#0f0':'#f00'}">FD: ${item.fd.toFixed(4)}%</span>
                    </div>
                    <div class="ai-box" id="ai-${item.s}">ç›£æ§ä¸­...</div>
                `;
                deck.appendChild(div);
                if (isH && !busy) callGemini(item);
            });
        }

        function callGemini(item) {
            busy = true;
            const box = document.getElementById(`ai-${item.s}`);
            box.innerText = ">> [LEVEL 3] æ­£åœ¨ç©¿é€ Google é–˜é“åˆ†ææ•¸æ“š...";

            getOI(item.s).then(oi => {
                const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + GK;
                const xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const res = JSON.parse(xhr.responseText);
                            const text = res.candidates[0].content.parts[0].text;
                            box.innerText = ">> " + text;
                            // Pushover
                            fetch("https://api.pushover.net/1/messages.json", {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                body: `token=${PT}&user=${PU}&message=${encodeURIComponent(text)}&title=ğŸ”±LEVEL3:${item.s}`
                            });
                        } else {
                            box.innerText = `âŒ é€£ç·šå¤±æ•— (ä»£ç¢¼:${xhr.status})\nè«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿ CORS å¤–æ›ï¼Œæˆ– Key æ˜¯å¦æœ‰æ•ˆã€‚`;
                        }
                        setTimeout(() => { busy = false; }, 10000);
                    }
                };

                const prompt = `ä½ æ˜¯ Trident LEVEL 3 å¼•æ“ã€‚æ¨™çš„:${item.s},è³‡è²»:${item.fd.toFixed(4)}%,åƒ¹æ ¼åºåˆ—:${item.histP.join('->')},æŒå€‰é‡:${oi}ã€‚
                è«‹äº¤å‰åˆ†æåƒ¹æ ¼èˆ‡æŒå€‰ï¼Œçµ¦å‡º:æ–¹å‘(å¤š/ç©º)ã€å‹ç‡ã€è¡¨æ…‹æ™‚é–“ã€‚ç¹ä¸­çµè«–ç¬¬ä¸€è¡Œã€‚`;

                xhr.send(JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }));
            });
        }
        init();
    </script>
</body>
</html>
