<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ðŸ”± TRIDENT V17.4 - AI RE-LOCKED</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .card { border: 1px solid #333; padding: 15px; margin-bottom: 10px; background: #050505; }
        .symbol { font-size: 1.5rem; color: #00ffcc; font-weight: bold; }
        .ai-box { background: #111; padding: 10px; color: #fff; border-left: 3px solid #00ffcc; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>ðŸ”± TRIDENT V17.4 <span style="color:#4285F4">Gemini Final</span></h2>
    <div id="deck"></div>

    <script>
        const GEMINI_KEY = "AIzaSyCK5cMo5FL895WwRzggkFjPi0JRe5tVqXQ";
        const PUSHOVER = { u: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", t: "acyoe3sz15x4n91r1349fdcau7x6pw" };
        const BLACKLIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];

        let market = {};
        let busy = false;

        async function init() {
            const r = await fetch("https://fapi.binance.com/fapi/v1/premiumIndex");
            const d = await r.json();
            d.forEach(i => {
                if (i.symbol.endsWith("USDT") && !BLACKLIST.includes(i.symbol)) {
                    market[i.symbol] = { s: i.symbol, fd: parseFloat(i.lastFundingRate)*100, p: i.markPrice, hist: [] };
                }
            });
            const ws = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");
            ws.onmessage = (e) => {
                JSON.parse(e.data).forEach(t => {
                    if (market[t.s]) {
                        market[t.s].p = t.c;
                        market[t.s].hist.push(t.c);
                        if(market[t.s].hist.length > 5) market[t.s].hist.shift();
                    }
                });
                draw();
            };
        }

        function draw() {
            const list = Object.values(market).filter(x => x.p).sort((a,b) => Math.abs(b.fd) - Math.abs(a.fd)).slice(0,3);
            const deck = document.getElementById("deck");
            deck.innerHTML = "";
            list.forEach(item => {
                const isAlert = Math.abs(item.fd) >= 0.05;
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `<span class="symbol">${item.s}</span> [FD: ${item.fd.toFixed(4)}%] <div id="ai-${item.s}" class="ai-box">ç³»çµ±å¾…å‘½...</div>`;
                deck.appendChild(div);
                if (isAlert && !busy) runGemini(item);
            });
        }

        async function runGemini(item) {
            busy = true;
            const box = document.getElementById(`ai-${item.s}`);
            box.innerText = ">> [AI é€£ç·šä¸­] æ­£åœ¨æŽ’é™¤ 404 éŒ¯èª¤...";

            // ç¶²å€è·¯å¾‘æ‹†è§£ï¼Œé˜²æ­¢è¢«ç€è¦½å™¨æˆªæ–·
            const baseURL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash";
            const action = ":generateContent";
            const fullURL = `${baseURL}${action}?key=${GEMINI_KEY}`;

            try {
                const response = await fetch(fullURL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `äº¤æ˜“æŒ‡ä»¤:åˆ†æžæ¨™çš„${item.s},è³‡è²»${item.fd}%,è¿‘æœŸèµ°å‹¢${item.hist.join('->')}ã€‚çµ¦å‡º:æ–¹å‘(å¤š/ç©º)ã€å‹çŽ‡ã€è¡¨æ…‹æ™‚é–“ã€‚ç¹ä¸­çµè«–ç¬¬ä¸€è¡Œã€‚` }] }]
                    })
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorMsg}`);
                }

                const data = await response.json();
                const res = data.candidates[0].content.parts[0].text;
                box.innerText = ">> " + res;

                if (res.includes("9") || res.includes("é«˜")) {
                    fetch("https://api.pushover.net/1/messages.json", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `token=${PUSHOVER.t}&user=${PUSHOVER.u}&message=${encodeURIComponent(res)}&title=ðŸ”±ç‹™æ“Š:${item.s}`
                    });
                }
            } catch (err) { 
                box.innerText = "âŒ é€£ç·šå¤±æ•—: " + err.message + "\n(è«‹æª¢æŸ¥æ©˜è‰²å¤–æŽ›æ˜¯å¦é—œé–‰æˆ–é™åˆ¶äº†è«‹æ±‚)"; 
            }
            finally { setTimeout(() => { busy = false; }, 10000); }
        }
        init();
    </script>
</body>
</html>
