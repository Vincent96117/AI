<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>üî± TRIDENT V17.3 - Á∂≤ÂùÄ‰øÆÊ≠£</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .card { border: 1px solid #333; padding: 15px; margin-bottom: 10px; background: #050505; }
        .symbol { font-size: 1.5rem; color: #00ffcc; font-weight: bold; }
        .ai-box { background: #111; padding: 10px; color: #fff; border-left: 3px solid #00ffcc; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>üî± TRIDENT V17.3 <span style="color:#4285F4">Gemini Fixed</span></h2>
    <div id="deck"></div>

    <script>
        const GEMINI_KEY = "AIzaSyCK5cMo5FL895WwRzggkFjPi0JRe5tVqXQ";
        const PUSHOVER = { u: "Gkhqyhobnxzjfwgvaiyp347m1jkhn4", t: "acyoe3sz15x4n91r1349fdcau7x6pw" };
        const BLACKLIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];

        let market = {};
        let busy = false;

        async function init() {
            const r = await fetch("https://fapi.binance.com/fapi/v1/premiumIndex");
            const d = await r.json();
            d.forEach(i => {
                if (i.symbol.endsWith("USDT") && !BLACKLIST.includes(i.symbol)) {
                    market[i.symbol] = { s: i.symbol, fd: parseFloat(i.lastFundingRate)*100, p: i.markPrice, hist: [] };
                }
            });
            const ws = new WebSocket("wss://fstream.binance.com/ws/!ticker@arr");
            ws.onmessage = (e) => {
                JSON.parse(e.data).forEach(t => {
                    if (market[t.s]) {
                        market[t.s].p = t.c;
                        market[t.s].hist.push(t.c);
                        if(market[t.s].hist.length > 10) market[t.s].hist.shift();
                    }
                });
                draw();
            };
        }

        function draw() {
            const list = Object.values(market).filter(x => x.p).sort((a,b) => Math.abs(b.fd) - Math.abs(a.fd)).slice(0,3);
            const deck = document.getElementById("deck");
            deck.innerHTML = "";
            list.forEach(item => {
                const isAlert = Math.abs(item.fd) >= 0.05;
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `<span class="symbol">${item.s}</span> [FD: ${item.fd.toFixed(4)}%] <div id="ai-${item.s}" class="ai-box">Ê∫ñÂÇôË®∫Êñ∑‰∏≠...</div>`;
                deck.appendChild(div);
                if (isAlert && !busy) runGemini(item);
            });
        }

        async function runGemini(item) {
            busy = true;
            const box = document.getElementById(`ai-${item.s}`);
            box.innerText = ">> [AI Ê≠£Âú®ÈÄ£Á∑ö] Ë´ãÊ±Ç Google ‰º∫ÊúçÂô®...";

            // ‰øÆÊ≠£ÂæåÁöÑÁ≤æÊ∫ñÁ∂≤ÂùÄ
            const apiURL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;

            try {
                const response = await fetch(apiURL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `‰Ω†ÊòØ‰∏Ä‰Ωç‰∫§ÊòìÂ∞àÂÆ∂„ÄÇÊ®ôÁöÑ:${item.s},Ë≥áË≤ª:${item.fd}%,Ëµ∞Âã¢:${item.hist.join('->')}„ÄÇË´ãÂàÜÊûêÔºö1.ÊñπÂêë(Â§ö/Á©∫) 2.Â§ö‰πÖË°®ÊÖã(min) 3.ÂãùÁéá„ÄÇÁπÅÈ´î‰∏≠ÊñáÁµêË´ñ„ÄÇ` }] }]
                    })
                });

                if (!response.ok) throw new Error(`HTTPÈåØË™§: ${response.status}`);

                const data = await response.json();
                const resText = data.candidates[0].content.parts[0].text;
                box.innerText = ">> " + resText;

                if (resText.includes("9") || resText.includes("È´ò")) {
                    fetch("https://api.pushover.net/1/messages.json", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `token=${PUSHOVER.t}&user=${PUSHOVER.u}&message=${encodeURIComponent(resText)}&title=üî±ÁãôÊìä:${item.s}`
                    });
                }
            } catch (err) { 
                box.innerText = "‚ùå ÈÄôÊ¨°ÁúüÁöÑÊòØÁ∂≤ÂùÄÂá∫ÈåØÔºåÊàëÊîπÂ•Ω‰∫ÜÔºÅ\nÈåØË™§ÂéüÂõ†: " + err.message; 
            }
            finally { setTimeout(() => { busy = false; }, 10000); }
        }
        init();
    </script>
</body>
</html>
